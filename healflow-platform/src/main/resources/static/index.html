<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealFlow - Incident ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; margin-bottom: 20px; }
        .filters { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filters select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .filters button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .filters button:hover { background: #0056b3; }
        .incident-list { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .incident-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .incident-item:hover { background: #f8f9fa; }
        .incident-item:last-child { border-bottom: none; }
        .incident-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .incident-id { font-weight: 600; color: #333; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-WAITING { background: #ffc107; color: #000; }
        .status-ANALYZING { background: #17a2b8; color: white; }
        .status-ANALYZED { background: #28a745; color: white; }
        .status-FIXING { background: #fd7e14; color: white; }
        .status-FIXED { background: #20c997; color: white; }
        .status-FAILED { background: #dc3545; color: white; }
        .incident-meta { font-size: 14px; color: #666; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #333; }
        .close-btn { font-size: 28px; cursor: pointer; color: #999; }
        .close-btn:hover { color: #333; }
        .detail-row { margin-bottom: 15px; }
        .detail-label { font-weight: 600; color: #666; margin-bottom: 5px; }
        .detail-value { color: #333; word-break: break-all; }
        .actions { margin-top: 20px; display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .empty { text-align: center; padding: 40px; color: #999; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ HealFlow - Incident ç®¡ç†</h1>

        <div class="filters">
            <label>çŠ¶æ€ç­›é€‰ï¼š</label>
            <select id="statusFilter">
                <option value="">å…¨éƒ¨</option>
                <option value="WAITING">WAITING</option>
                <option value="ANALYZING">ANALYZING</option>
                <option value="ANALYZED">ANALYZED</option>
                <option value="FIXING">FIXING</option>
                <option value="FIXED">FIXED</option>
                <option value="FAILED">FAILED</option>
            </select>
            <button onclick="loadIncidents()">åˆ·æ–°</button>
        </div>

        <div class="incident-list" id="incidentList">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Incident è¯¦æƒ…</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        let currentIncident = null;

        async function loadIncidents() {
            const status = document.getElementById('statusFilter').value;
            const url = status ? `/api/v1/incidents?status=${status}` : '/api/v1/incidents';

            try {
                const response = await fetch(url);
                const incidents = await response.json();
                renderIncidents(incidents);
            } catch (error) {
                document.getElementById('incidentList').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>';
            }
        }

        function renderIncidents(incidents) {
            const container = document.getElementById('incidentList');

            if (incidents.length === 0) {
                container.innerHTML = '<div class="empty">æš‚æ—  Incident</div>';
                return;
            }

            container.innerHTML = incidents.map(inc => `
                <div class="incident-item" onclick="showDetail('${inc.id}')">
                    <div class="incident-header">
                        <span class="incident-id">${inc.id}</span>
                        <span class="status-badge status-${inc.status}">${inc.status}</span>
                    </div>
                    <div class="incident-meta">
                        <strong>App:</strong> ${inc.appId} |
                        <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(inc.createdAt).toLocaleString('zh-CN')}
                    </div>
                </div>
            `).join('');
        }

        async function showDetail(incidentId) {
            try {
                const response = await fetch(`/api/v1/incidents/${incidentId}`);
                currentIncident = await response.json();
                renderDetail(currentIncident);
                document.getElementById('detailModal').style.display = 'block';
            } catch (error) {
                alert('åŠ è½½è¯¦æƒ…å¤±è´¥');
            }
        }

        function renderDetail(inc) {
            const actions = getAvailableActions(inc.status);

            document.getElementById('detailContent').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Incident ID</div>
                    <div class="detail-value">${inc.id}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">åº”ç”¨ ID</div>
                    <div class="detail-value">${inc.appId}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">çŠ¶æ€</div>
                    <div class="detail-value"><span class="status-badge status-${inc.status}">${inc.status}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">ä»“åº“ URL</div>
                    <div class="detail-value">${inc.repoUrl || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">åˆ†æ”¯</div>
                    <div class="detail-value">${inc.branch || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Session ID</div>
                    <div class="detail-value">${inc.sessionId || '-'}</div>
                </div>
                ${inc.errorType || inc.errorMessage || inc.stackTrace ? `
                <div class="detail-row">
                    <div class="detail-label">é”™è¯¯ç±»å‹</div>
                    <div class="detail-value">${inc.errorType || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">é”™è¯¯ä¿¡æ¯</div>
                    <div class="detail-value">${inc.errorMessage || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">å †æ ˆè·Ÿè¸ª</div>
                    <div class="detail-value"><pre style="max-height: 300px; overflow-y: auto; font-size: 12px;">${inc.stackTrace || '-'}</pre></div>
                </div>
                ` : ''}
                ${inc.analysisResult ? `
                <div class="detail-row">
                    <div class="detail-label">åˆ†æç»“æœ</div>
                    <div class="detail-value"><pre>${inc.analysisResult}</pre></div>
                </div>
                ` : ''}
                ${inc.fixProposal ? `
                <div class="detail-row">
                    <div class="detail-label">ä¿®å¤æ–¹æ¡ˆ</div>
                    <div class="detail-value"><pre>${inc.fixProposal}</pre></div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">åˆ›å»ºæ—¶é—´</div>
                    <div class="detail-value">${new Date(inc.createdAt).toLocaleString('zh-CN')}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æ›´æ–°æ—¶é—´</div>
                    <div class="detail-value">${new Date(inc.updatedAt).toLocaleString('zh-CN')}</div>
                </div>
                <div class="actions">
                    ${actions}
                </div>
            `;
        }

        function getAvailableActions(status) {
            switch(status) {
                case 'WAITING':
                    return '<button class="btn btn-primary" onclick="analyzeIncident()">ğŸ” å¼€å§‹åˆ†æ</button>';
                case 'ANALYZED':
                    return '<button class="btn btn-warning" onclick="generateFix()">ğŸ”§ ç”Ÿæˆä¿®å¤æ–¹æ¡ˆ</button>';
                case 'FIXING':
                    return '<button class="btn btn-success" onclick="applyFix()">âœ… åº”ç”¨ä¿®å¤</button>';
                case 'FIXED':
                    return '<span style="color: #28a745;">âœ… å·²ä¿®å¤å®Œæˆ</span>';
                case 'FAILED':
                    return '<span style="color: #dc3545;">âŒ å¤„ç†å¤±è´¥</span>';
                default:
                    return '';
            }
        }

        async function analyzeIncident() {
            if (!currentIncident) return;

            if (!confirm('ç¡®å®šè¦å¼€å§‹åˆ†æå—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) return;

            try {
                const response = await fetch(`/api/v1/incidents/${currentIncident.id}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appId: currentIncident.appId,
                        repoUrl: currentIncident.repoUrl,
                        branch: currentIncident.branch,
                        errorType: currentIncident.errorType || 'Unknown',
                        errorMessage: currentIncident.errorMessage || 'No error message',
                        stackTrace: currentIncident.stackTrace || ''
                    })
                });

                if (response.ok) {
                    alert('åˆ†æå·²å¼€å§‹ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹ç»“æœ');
                    closeModal();
                    loadIncidents();
                } else {
                    alert('åˆ†æå¤±è´¥');
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function generateFix() {
            if (!currentIncident) return;

            if (!confirm('ç¡®å®šè¦ç”Ÿæˆä¿®å¤æ–¹æ¡ˆå—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/v1/incidents/${currentIncident.id}/generate-fix`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('ä¿®å¤æ–¹æ¡ˆç”Ÿæˆå·²å¼€å§‹ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹ç»“æœ');
                    closeModal();
                    loadIncidents();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function applyFix() {
            if (!currentIncident) return;

            if (!confirm('ç¡®å®šè¦åº”ç”¨ä¿®å¤å—ï¼Ÿè¿™å°†ä¿®æ”¹ä»£ç å¹¶è¿è¡Œæµ‹è¯•ã€‚')) return;

            try {
                const response = await fetch(`/api/v1/incidents/${currentIncident.id}/apply-fix`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('ä¿®å¤åº”ç”¨å·²å¼€å§‹ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹ç»“æœ');
                    closeModal();
                    loadIncidents();
                } else {
                    alert('åº”ç”¨å¤±è´¥');
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentIncident = null;
        }

        document.getElementById('statusFilter').addEventListener('change', loadIncidents);

        loadIncidents();
    </script>
</body>
</html>
