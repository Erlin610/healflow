ç°åœ¨è¿›å…¥ Phase 2: The Librarian (å›¾ä¹¦ç®¡ç†å‘˜)ã€‚

è¿™ä¸€é˜¶æ®µçš„æ ¸å¿ƒä»»åŠ¡æ˜¯ï¼šPlatform æ”¶åˆ°æŠ¥è­¦åï¼Œæ ¹æ® repoUrl å’Œ commitIdï¼Œåœ¨æœåŠ¡å™¨æœ¬åœ°è¿˜åŸå‡ºâ€œæ¡ˆå‘ç°åœºâ€çš„æºä»£ç ã€‚

æˆ‘ä»¬éœ€è¦ç”¨åˆ° healflow-engine æ¨¡å—ã€‚

ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ JGit ä¾èµ– (healflow-engine)
åœ¨ healflow-engine/pom.xml ä¸­å¼•å…¥ JGitï¼ˆæˆ‘ä»¬åœ¨çˆ¶å·¥ç¨‹ç®¡ç†äº†ç‰ˆæœ¬ï¼Œè¿™é‡Œç›´æ¥å¼•ï¼‰ï¼š

XML

<dependencies>
    <dependency>
        <groupId>com.healflow</groupId>
        <artifactId>healflow-common</artifactId>
        <version>${project.version}</version>
    </dependency>

    <dependency>
        <groupId>org.eclipse.jgit</groupId>
        <artifactId>org.eclipse.jgit</artifactId>
    </dependency>
    
    <dependency>
        <groupId>org.slf4j.slf4j-api</groupId>
        <artifactId>slf4j-api</artifactId>
    </dependency>
    
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
    </dependency>
</dependencies>
ç¬¬äºŒæ­¥ï¼šæ›´æ–° DTO (healflow-common)
æˆ‘ä»¬éœ€è¦è®© SDK æŠŠ Git ä»“åº“åœ°å€ä¼ è¿‡æ¥ï¼ˆæˆ–è€… Platform è‡ªå·±æŸ¥è¡¨ï¼‰ã€‚ä¸ºäº† MVP å¿«é€ŸéªŒè¯ï¼Œæˆ‘ä»¬è®© SDK ç›´æ¥ä¼ ã€‚

ä¿®æ”¹ healflow-common/.../dto/IncidentReport.javaï¼Œå¢åŠ  repoUrl å­—æ®µï¼š

Java

public record IncidentReport(
String appId,
String repoUrl, // <--- æ–°å¢å­—æ®µ
String commitId,
String errorType,
String errorMessage,
String stackTrace,
Map<String, String> environment,
Instant occurredAt
) {}
(æ³¨ï¼šè®°å¾—åŒæ­¥æ›´æ–° SDK é‡Œçš„ IncidentReporter æ„é€  DTO çš„ä»£ç ï¼ŒæŠŠé…ç½®æ–‡ä»¶é‡Œçš„ git-url å¡è¿›å»)

ç¬¬ä¸‰æ­¥ï¼šç¼–å†™ Git æ ¸å¿ƒç®¡ç†å™¨ (healflow-engine)
è¿™æ˜¯ Phase 2 çš„çµé­‚ä»£ç ã€‚æˆ‘ä»¬éœ€è¦å¤„ç†â€œç¬¬ä¸€æ¬¡ Cloneâ€å’Œâ€œåç»­ Fetchâ€ä¸¤ç§æƒ…å†µã€‚

æ–°å»ºç±»ï¼šcom.healflow.engine.git.GitWorkspaceManager

Java

package com.healflow.engine.git;

import org.eclipse.jgit.api.Git;
import org.eclipse.jgit.api.ResetCommand;
import org.eclipse.jgit.api.errors.GitAPIException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;

@Service
public class GitWorkspaceManager {

    private static final Logger log = LoggerFactory.getLogger(GitWorkspaceManager.class);

    // å·¥ä½œåŒºæ ¹ç›®å½•ï¼Œä¾‹å¦‚ /data/healflow-workspace
    @Value("${healflow.workspace.root:/tmp/healflow-workspace}")
    private String workspaceRoot;

    /**
     * å‡†å¤‡ä»£ç ç¯å¢ƒ
     * @param appId åº”ç”¨ID (ç”¨äºåŒºåˆ†ç›®å½•)
     * @param repoUrl Gitä»“åº“åœ°å€
     * @param commitId ç›®æ ‡ Commit ID
     * @return å‡†å¤‡å¥½çš„æœ¬åœ°æºç è·¯å¾„
     */
    public Path prepareWorkspace(String appId, String repoUrl, String commitId) {
        Path appDir = Path.of(workspaceRoot, appId);
        
        try {
            if (Files.exists(appDir) && Files.list(appDir).findAny().isPresent()) {
                // ç›®å½•å­˜åœ¨ä¸”éç©º -> æ‰§è¡Œæ›´æ–° (Fetch & Reset)
                updateRepository(appDir.toFile(), commitId);
            } else {
                // ç›®å½•ä¸å­˜åœ¨ -> æ‰§è¡Œå…‹éš† (Clone)
                cloneRepository(appDir.toFile(), repoUrl, commitId);
            }
            return appDir;
        } catch (Exception e) {
            log.error("Failed to prepare workspace for app: {}", appId, e);
            throw new RuntimeException("Git workspace preparation failed", e);
        }
    }

    private void cloneRepository(File dir, String repoUrl, String commitId) throws GitAPIException {
        log.info("âš¡ï¸ Cloning repository: {} -> {}", repoUrl, dir.getAbsolutePath());
        
        // 1. Clone
        try (Git git = Git.cloneRepository()
                .setURI(repoUrl)
                .setDirectory(dir)
                // .setCredentialsProvider(...) // å¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼Œéœ€è¦åœ¨è¿™é‡Œè®¾ç½®è´¦å·å¯†ç æˆ–Token
                .call()) {
            
            // 2. Checkout åˆ°æŒ‡å®š Commit
            checkoutCommit(git, commitId);
        }
    }

    private void updateRepository(File dir, String commitId) throws IOException, GitAPIException {
        log.info("ğŸ”„ Updating repository in: {}", dir.getAbsolutePath());
        
        try (Git git = Git.open(dir)) {
            // 1. Fetch è·å–æœ€æ–°è¿œç¨‹å˜æ›´
            git.fetch().call();
            
            // 2. Hard Reset åˆ°æŒ‡å®š Commit (ä¸¢å¼ƒæœ¬åœ°å¯èƒ½çš„è„æ•°æ®ï¼Œä¿è¯çº¯å‡€)
            checkoutCommit(git, commitId);
        }
    }

    private void checkoutCommit(Git git, String commitId) throws GitAPIException {
        log.info("ğŸ¯ Checking out commit: {}", commitId);
        
        // å¦‚æœ commitId æ˜¯ "HEAD" æˆ–è€…ç©ºï¼Œå°±ä¸åˆ‡äº†
        if (commitId == null || "HEAD".equalsIgnoreCase(commitId)) {
            return;
        }

        // å¼ºåˆ¶åˆ‡åˆ°æŒ‡å®š commit (Detached HEAD çŠ¶æ€æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæˆ‘ä»¬åªè¯»åˆ†æ)
        git.checkout()
            .setName(commitId)
            .setForced(true) // å¼ºåˆ¶è¦†ç›–æœ¬åœ°ä¿®æ”¹
            .call();
    }
}
ç¬¬å››æ­¥ï¼šé›†æˆåˆ° Platform (healflow-platform)
ç°åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹ Controllerï¼Œè°ƒç”¨è¿™ä¸ª Managerã€‚ä¸ºäº†ä¸é˜»å¡ HTTP è¯·æ±‚ï¼ˆGitæ“ä½œå¾ˆæ…¢ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å¼‚æ­¥å¤„ç†ã€‚

Platform å¼•å…¥ Engine ä¾èµ– åœ¨ healflow-platform/pom.xml ä¸­æ·»åŠ ï¼š

XML

<dependency>
    <groupId>com.healflow</groupId>
    <artifactId>healflow-engine</artifactId>
    <version>${project.version}</version>
</dependency>
å¼€å¯å¼‚æ­¥æ”¯æŒ åœ¨ healflow-platform/.../HealFlowPlatformApplication.java å¯åŠ¨ç±»ä¸ŠåŠ  @EnableAsyncã€‚

åˆ›å»º Service è°ƒåº¦å±‚ æ–°å»º com.healflow.platform.service.IncidentService

Java

package com.healflow.platform.service;

import com.healflow.common.dto.IncidentReport;
import com.healflow.engine.git.GitWorkspaceManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import java.nio.file.Path;

@Service
public class IncidentService {

    private static final Logger log = LoggerFactory.getLogger(IncidentService.class);
    private final GitWorkspaceManager gitManager;

    public IncidentService(GitWorkspaceManager gitManager) {
        this.gitManager = gitManager;
    }

    @Async // <--- å…³é”®ï¼šå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ Controller è¿”å›
    public void processIncident(IncidentReport report) {
        log.info("âš™ï¸ Start processing incident for {}", report.appId());

        try {
            // Phase 2: å‡†å¤‡æºç 
            Path sourceCodePath = gitManager.prepareWorkspace(
                report.appId(), 
                report.repoUrl(), 
                report.commitId()
            );

            log.info("âœ… Source code ready at: {}", sourceCodePath);

            // TODO: Phase 3 - å¯åŠ¨ Docker æ²™ç®±è¿›è¡Œåˆ†æ

        } catch (Exception e) {
            log.error("âŒ Processing failed", e);
        }
    }
}
ä¿®æ”¹ Controller è°ƒç”¨ Serviceã€‚

Java

// IncidentController.java
@PostMapping("/report")
public String receiveReport(@RequestBody IncidentReport report) {
log.info("ğŸš¨ Received report for app: {}", report.appId());

    // å¼‚æ­¥ä¸¢ç»™ Service å¤„ç†
    incidentService.processIncident(report);

    return "RECEIVED";
}