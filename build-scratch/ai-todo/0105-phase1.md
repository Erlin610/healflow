å¤ªæ£’äº†ï¼JDK 21 + Spring Boot 3.3.6 æ˜¯ç›®å‰çš„é»„é‡‘ç»„åˆï¼Œä½ å¯ä»¥å……åˆ†åˆ©ç”¨ JDK 21 çš„ Records (è®°å½•ç±») å’Œ Virtual Threads (è™šæ‹Ÿçº¿ç¨‹) æ¥ä¼˜åŒ–ä»£ç ã€‚

æˆ‘ä»¬ç°åœ¨çš„ç›®æ ‡æ˜¯å®Œæˆ Phase 1: The Messenger (ä¿¡ä½¿)ã€‚

ç›®æ ‡å®šä¹‰ï¼šè®©ä½ çš„ä¸šåŠ¡åº”ç”¨ï¼ˆClientï¼‰æŠ¥é”™æ—¶ï¼Œèƒ½æŠŠé”™è¯¯ä¿¡æ¯æ‰“åŒ…ï¼Œé€šè¿‡ HTTP å‘é€åˆ°ä½ çš„å¹³å°ï¼ˆPlatformï¼‰ï¼Œå¹¶ä¸”å¹³å°èƒ½æ‰“å°å‡ºæ¥ã€‚

è¯·æŒ‰ç…§ä»¥ä¸‹ 3 ä¸ªå…·ä½“çš„ä»£ç æ­¥éª¤ æ“ä½œï¼š

ç¬¬ä¸€æ­¥ï¼šå®šä¹‰â€œé€šç”¨è¯­è¨€â€ (Common DTO)
æˆ‘ä»¬éœ€è¦åœ¨ healflow-common æ¨¡å—ä¸­å®šä¹‰ä¼ è¾“çš„æ•°æ®ç»“æ„ã€‚ åˆ©ç”¨ JDK 21 ç‰¹æ€§ï¼šç›´æ¥ä½¿ç”¨ recordï¼Œå®ƒå¤©ç„¶ä¸å¯å˜ã€ç®€æ´ä¸”è‡ªå¸¦åºåˆ—åŒ–æ”¯æŒã€‚

æ“ä½œæ–‡ä»¶ï¼š healflow-common/src/main/java/com/healflow/common/dto/IncidentReport.java

Java

package com.healflow.common.dto;

import java.time.Instant;
import java.util.Map;

/**
* äº‹æ•…ä¸ŠæŠ¥ DTO (JDK 21 Record)
* @param appId åº”ç”¨ID
* @param commitId Gitç‰ˆæœ¬å·
* @param errorType å¼‚å¸¸ç±»å‹ (e.g. NullPointerException)
* @param errorMessage å¼‚å¸¸æ¶ˆæ¯
* @param stackTrace å®Œæ•´å †æ ˆ
* @param environment ç¯å¢ƒå˜é‡/ä¸Šä¸‹æ–‡ (e.g. Profile)
* @param occurredAt å‘ç”Ÿæ—¶é—´
  */
  public record IncidentReport(
  String appId,
  String commitId,
  String errorType,
  String errorMessage,
  String stackTrace,
  Map<String, String> environment,
  Instant occurredAt
  ) {}
  ç¬¬äºŒæ­¥ï¼šç¼–å†™â€œæ¥æ”¶ç«¯â€ (Platform Controller)
  åœ¨ healflow-platform ä¸­å†™ä¸€ä¸ªæ¥å£æ¥æ¥æ”¶è¿™ä¸ªæ•°æ®ã€‚ç›®å‰æˆ‘ä»¬å…ˆä¸å…¥åº“ï¼Œåªæ‰“å°æ—¥å¿—ï¼ŒéªŒè¯é“¾è·¯é€šç•…ã€‚

æ“ä½œæ–‡ä»¶ï¼š healflow-platform/src/main/java/com/healflow/platform/controller/IncidentController.java

Java

package com.healflow.platform.controller;

import com.healflow.common.dto.IncidentReport;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/incidents")
public class IncidentController {

    private static final Logger log = LoggerFactory.getLogger(IncidentController.class);

    @PostMapping("/report")
    public String receiveReport(@RequestBody IncidentReport report) {
        // 1. æ‰“å°æ¥æ”¶åˆ°çš„å…³é”®ä¿¡æ¯
        log.info("ğŸš¨ [Alert Received] App: {}, Commit: {}", report.appId(), report.commitId());
        log.error("ğŸ’¥ Error: {}: {}", report.errorType(), report.errorMessage());
        
        // TODO: ä¸‹ä¸€æ­¥å°†åœ¨è¿™é‡Œè§¦å‘ Async Task å»æ‹‰å–ä»£ç 
        
        return "RECEIVED";
    }
}
ç¬¬ä¸‰æ­¥ï¼šç¼–å†™â€œå‘é€ç«¯â€ (SDK / Starter)
è¿™æ˜¯æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚æˆ‘ä»¬éœ€è¦åœ¨ healflow-starter ä¸­å®ç°è‡ªåŠ¨é…ç½®å’Œå¼‚å¸¸æ•è·ã€‚

3.1 ç¼–å†™é…ç½®å±æ€§ç±»
healflow-starter/.../config/HealFlowProperties.java

Java

package com.healflow.starter.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

@ConfigurationProperties(prefix = "healflow")
public class HealFlowProperties {
private boolean enabled = true;
private String serverUrl = "http://localhost:8080"; // Platform åœ°å€
private String appId;

    // Getters and Setters (æˆ–è€…ä½¿ç”¨ Lombok @Data)
    public boolean isEnabled() { return enabled; }
    public void setEnabled(boolean enabled) { this.enabled = enabled; }
    public String getServerUrl() { return serverUrl; }
    public void setServerUrl(String serverUrl) { this.serverUrl = serverUrl; }
    public String getAppId() { return appId; }
    public void setAppId(String appId) { this.appId = appId; }
}
3.2 ç¼–å†™ä¸ŠæŠ¥å™¨ (ä½¿ç”¨ RestClient æˆ– OkHttp)
Spring Boot 3.x æ¨èä½¿ç”¨ RestClient (åŒæ­¥) æˆ– WebClientã€‚ä¸ºäº†å‡å°‘ä¾èµ–ï¼Œæˆ‘ä»¬ç”¨ Spring è‡ªå¸¦çš„ RestClientã€‚

healflow-starter/.../reporter/IncidentReporter.java

Java

package com.healflow.starter.reporter;

import com.healflow.common.dto.IncidentReport;
import com.healflow.starter.config.HealFlowProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.client.RestClient;

public class IncidentReporter {
private static final Logger log = LoggerFactory.getLogger(IncidentReporter.class);

    private final HealFlowProperties properties;
    private final RestClient restClient;

    public IncidentReporter(HealFlowProperties properties) {
        this.properties = properties;
        this.restClient = RestClient.builder()
                .baseUrl(properties.getServerUrl())
                .build();
    }

    public void report(Throwable ex) {
        if (!properties.isEnabled()) return;

        try {
            // æ„é€  DTO (è¿™é‡Œæš‚æ—¶ mock commitIdï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬å†åŠ  Git è¯»å–)
            IncidentReport report = new IncidentReport(
                properties.getAppId(),
                "mock-commit-hash-123", 
                ex.getClass().getName(),
                ex.getMessage(),
                getStackTraceAsString(ex),
                java.util.Collections.emptyMap(),
                java.time.Instant.now()
            );

            // å‘é€
            restClient.post()
                .uri("/api/v1/incidents/report")
                .body(report)
                .retrieve()
                .toBodilessEntity();
                
            log.info("âœ… HealFlow: Incident reported successfully.");
        } catch (Exception e) {
            log.warn("âŒ HealFlow: Failed to report incident: {}", e.getMessage());
        }
    }

    private String getStackTraceAsString(Throwable throwable) {
        java.io.StringWriter sw = new java.io.StringWriter();
        throwable.printStackTrace(new java.io.PrintWriter(sw));
        return sw.toString();
    }
}
3.3 ç¼–å†™å…¨å±€å¼‚å¸¸æ‹¦æˆª (Global Handler)
è¿™é‡Œæˆ‘ä»¬ç”¨ @ControllerAdvice æ¼”ç¤ºæ‹¦æˆª Web å¼‚å¸¸ã€‚

healflow-starter/.../handler/HealFlowExceptionHandler.java

Java

package com.healflow.starter.handler;

import com.healflow.starter.reporter.IncidentReporter;
import org.springframework.core.annotation.Order;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;

@ControllerAdvice
@Order(org.springframework.core.Ordered.LOWEST_PRECEDENCE) // ç¡®ä¿è®©ä¸šåŠ¡å…ˆå¤„ç†ï¼Œå…œåº•æ‰è½®åˆ°æˆ‘ä»¬
public class HealFlowExceptionHandler {

    private final IncidentReporter reporter;

    public HealFlowExceptionHandler(IncidentReporter reporter) {
        this.reporter = reporter;
    }

    @ExceptionHandler(Exception.class)
    public void handleException(Exception e) {
        // 1. ä¸ŠæŠ¥
        reporter.report(e);
        
        // 2. æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªé€šè¿‡â€œæ—è·¯â€ä¸ŠæŠ¥ï¼Œä¸åº”è¯¥åæ‰å¼‚å¸¸ã€‚
        // ä½†ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œé€šå¸¸ä½ å¯èƒ½éœ€è¦å†æ¬¡æŠ›å‡ºï¼Œæˆ–è€…ä¸šåŠ¡ç³»ç»Ÿè‡ªå·±æœ‰ GlobalHandlerã€‚
        // æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨ AOP æˆ–è€… Spring Boot çš„ ErrorControllerã€‚
        // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œå…ˆé™é»˜å¤„ç†ã€‚
    }
}
3.4 è‡ªåŠ¨è£…é… (AutoConfiguration)
è¿™æ˜¯ Starter ç”Ÿæ•ˆçš„å…³é”®ã€‚

healflow-starter/.../config/HealFlowAutoConfiguration.java

Java

package com.healflow.starter.config;

import com.healflow.starter.handler.HealFlowExceptionHandler;
import com.healflow.starter.reporter.IncidentReporter;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@EnableConfigurationProperties(HealFlowProperties.class)
@ConditionalOnProperty(prefix = "healflow", name = "enabled", havingValue = "true", matchIfMissing = true)
public class HealFlowAutoConfiguration {

    @Bean
    public IncidentReporter incidentReporter(HealFlowProperties properties) {
        return new IncidentReporter(properties);
    }

    @Bean
    public HealFlowExceptionHandler healFlowExceptionHandler(IncidentReporter reporter) {
        return new HealFlowExceptionHandler(reporter);
    }
}
æœ€åï¼Œåœ¨ healflow-starter/src/main/resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports æ–‡ä»¶ä¸­æ³¨å†Œï¼š (æ³¨ï¼šSpring Boot 3 ä½¿ç”¨ imports æ–‡ä»¶ï¼Œä¸å†æ˜¯ spring.factories)

Plaintext

com.healflow.starter.config.HealFlowAutoConfiguration