ç°åœ¨æˆ‘ä»¬è¿›å…¥ Phase 4: The Puppet Master (å‚€å„¡å¸ˆ - äº¤äº’å¼æ§åˆ¶)ã€‚

è¿™ä¸€é˜¶æ®µçš„æŒ‘æˆ˜åœ¨äºï¼šçœŸæ­£çš„ AI Agentï¼ˆå¦‚ Claude Codeï¼‰åœ¨åˆ†æå’Œä¿®æ”¹ä»£ç æ—¶ï¼Œä¼šåƒäººä¸€æ ·åœä¸‹æ¥é—®ä½ ï¼šâ€œæˆ‘æƒ³è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥å—ï¼Ÿ(y/n)â€ æˆ–è€… â€œæˆ‘æƒ³æ‰§è¡Œè¿™ä¸ªæµ‹è¯•ï¼Œç¡®è®¤å—ï¼Ÿâ€ã€‚

å¦‚æœæˆ‘ä»¬çš„ç¨‹åºå‚»å‚»åœ°ç­‰ç€ï¼Œå°±ä¼šå¡æ­»ï¼ˆHangï¼‰ã€‚æˆ‘ä»¬éœ€è¦è®© Java å˜æˆä¸€ä¸ªâ€œå‚€å„¡å¸ˆâ€ï¼Œè‡ªåŠ¨å¸®æˆ‘ä»¬å›ç­”â€œYesâ€ã€‚

Phase 4 å®æ–½æ­¥éª¤
æˆ‘ä»¬å°†åˆ†ä¸‰æ­¥èµ°ï¼š

é€ ä¸€ä¸ªå‡ Agent (Mock Agent)ï¼šå…ˆåˆ«æ€¥ç€æ¥çœŸ Claudeï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªè„šæœ¬æ¨¡ä»¿å®ƒâ€œæé—®-ç­‰å¾…â€çš„è¡Œä¸ºï¼Œç”¨æ¥æµ‹è¯•ä½ çš„ Java ä»£ç èƒ½ä¸èƒ½è‡ªåŠ¨å›ç­”ã€‚

ç¼–å†™ InteractiveRunner (äº¤äº’è¿è¡Œå™¨)ï¼šè¿™æ˜¯æ ¸å¿ƒä»£ç ï¼Œè´Ÿè´£â€œç›‘å¬æé—®â€å¹¶â€œè‡ªåŠ¨å†™å…¥å›ç­”â€ã€‚

é›†æˆéªŒè¯ï¼šçœ‹ Java èƒ½å¦æˆåŠŸâ€œéª—è¿‡â€å‡ Agentã€‚

ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Mock Agent è„šæœ¬
æˆ‘ä»¬éœ€è¦åœ¨å®¿ä¸»æœºçš„é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼ˆä¹Ÿå°±æ˜¯ E:\tmp\healflow-workspace\demo-service-01ï¼Œæˆ–è€…ä½ åˆšæ‰æµ‹è¯•çš„é‚£ä¸ªç›®å½•ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿè„šæœ¬ã€‚

å› ä¸ºæˆ‘ä»¬åœ¨ç”¨ Ubuntu å®¹å™¨ï¼Œæ‰€ä»¥å†™ä¸€ä¸ª Shell è„šæœ¬ æœ€æ–¹ä¾¿ã€‚

è¯·åœ¨ä½ çš„ Demo é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ mock-agent.shï¼š

Bash

#!/bin/bash

# æ¨¡æ‹Ÿ AI æ€è€ƒ
echo "ğŸ¤– AI: Analyzing project structure..."
sleep 1

# æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªæé—® (è¯»å–æƒé™)
echo "â“ AI: I need to read 'pom.xml'. Allow? [y/N]"
read -r response  # è¿™é‡Œä¼šæš‚åœï¼Œç­‰å¾… Java è¾“å…¥

if [[ "$response" == "y" ]]; then
echo "âœ… AI: Permission granted. Reading file..."
else
echo "âŒ AI: Permission denied. Aborting."
exit 1
fi

sleep 1

# æ¨¡æ‹Ÿç¬¬äºŒä¸ªæé—® (å†™å…¥æƒé™)
echo "â“ AI: I found a bug. I want to create 'Fix.java'. Allow write? [y/N]"
read -r response2

if [[ "$response2" == "y" ]]; then
echo "âœ… AI: Fix applied successfully."
# çœŸçš„åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¯æ˜æˆåŠŸäº†
echo "public class Fix {}" > /src/Fix.java
else
echo "âŒ AI: Write denied."
exit 1
end
(æ³¨æ„ï¼šå¦‚æœæ˜¯ Windows ç¼–è¾‘ï¼Œè¯·ç¡®ä¿æ¢è¡Œç¬¦æ˜¯ LFï¼Œæˆ–è€…åœ¨å®¹å™¨é‡Œè·‘çš„æ—¶å€™æ²¡é—®é¢˜)

ç¬¬äºŒæ­¥ï¼šç¼–å†™äº¤äº’å¼è¿è¡Œå™¨ (healflow-engine)
æˆ‘ä»¬éœ€è¦å‡çº§ DockerSandboxManagerï¼Œè®©å®ƒæ”¯æŒäº¤äº’ã€‚

æ–°å»ºæ ¸å¿ƒç±»ï¼šcom.healflow.engine.sandbox.InteractiveRunner.java

è¿™ä¸ªç±»æ¯”è¾ƒå¤æ‚ï¼Œå®ƒä½¿ç”¨äº†åŒçº¿ç¨‹æ¨¡å‹ï¼šä¸€ä¸ªçº¿ç¨‹è¯»è¾“å‡ºï¼ˆè€³æœµï¼‰ï¼Œä¸»çº¿ç¨‹å†™è¾“å…¥ï¼ˆå˜´å·´ï¼‰ã€‚

Java

package com.healflow.engine.sandbox;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.io.*;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.regex.Pattern;

@Component
public class InteractiveRunner {

    private static final Logger log = LoggerFactory.getLogger(InteractiveRunner.class);

    // å®šä¹‰æˆ‘ä»¬éœ€è¦è‡ªåŠ¨å›ç­”çš„â€œè§¦å‘è¯â€ (æ­£åˆ™)
    // æ¯”å¦‚åŒ¹é…: "Allow? [y/N]" æˆ– "Confirm execution?"
    private static final List<Pattern> AUTO_APPROVE_PATTERNS = List.of(
            Pattern.compile("(?i).*allow.*y/n.*"),
            Pattern.compile("(?i).*confirm.*y/n.*")
    );

    public void runInteractive(List<String> command, long timeoutSeconds) {
        ProcessBuilder pb = new ProcessBuilder(command);
        pb.redirectErrorStream(true); // åˆå¹¶ stderr åˆ° stdout

        Process process = null;
        try {
            log.info("ğŸš€ Starting Interactive Agent: {}", String.join(" ", command));
            process = pb.start();

            // è·å–è¾“å…¥æµ (ç”¨æ¥ç»™å­è¿›ç¨‹å†™æ•°æ® - ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„"å˜´å·´")
            BufferedWriter writer = new BufferedWriter(
                    new OutputStreamWriter(process.getOutputStream(), StandardCharsets.UTF_8));

            // è·å–è¾“å‡ºæµ (ç”¨æ¥å¬å­è¿›ç¨‹è¯´è¯ - ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„"è€³æœµ")
            BufferedReader reader = new BufferedReader(
                    new InputStreamReader(process.getInputStream(), StandardCharsets.UTF_8));

            String line;
            // å¾ªç¯è¯»å–æ¯ä¸€è¡Œè¾“å‡º
            while ((line = reader.readLine()) != null) {
                log.info("ğŸ¤– [Agent]: {}", line); // æ‰“å° AI è¯´çš„è¯

                // æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦å›ç­”
                if (shouldAutoApprove(line)) {
                    log.info("âš¡ï¸ [HealFlow]: Detected prompt, auto-approving with 'y'...");
                    
                    writer.write("y");
                    writer.newLine(); // å›è½¦
                    writer.flush();   // å¿…é¡» flush ç¡®ä¿å‘é€
                }
            }

            // ç­‰å¾…è¿›ç¨‹ç»“æŸ
            boolean finished = process.waitFor(timeoutSeconds, TimeUnit.SECONDS);
            if (!finished) {
                process.destroyForcibly();
                throw new RuntimeException("Agent execution timed out!");
            }

        } catch (Exception e) {
            log.error("Interactive execution failed", e);
            throw new RuntimeException(e);
        } finally {
            if (process != null && process.isAlive()) {
                process.destroy();
            }
        }
    }

    private boolean shouldAutoApprove(String line) {
        for (Pattern pattern : AUTO_APPROVE_PATTERNS) {
            if (pattern.matcher(line).matches()) {
                return true;
            }
        }
        return false;
    }
}
ç¬¬ä¸‰æ­¥ï¼šé›†æˆåˆ° Service å¹¶æµ‹è¯•
ä¿®æ”¹ IncidentService.javaï¼Œè¿™æ¬¡æˆ‘ä»¬ä¸è·‘ ls -al äº†ï¼Œæˆ‘ä»¬è·‘é‚£ä¸ª Mock è„šæœ¬ã€‚

Java

    @Autowired
    private InteractiveRunner interactiveRunner; // æ³¨å…¥æ–°ç»„ä»¶

    @Async
    public void processIncident(IncidentReport report) {
        // ... å‰é¢ Git å‡†å¤‡ä»£ç ä¸å˜ ...
        
        // æ„é€  Docker å‘½ä»¤æ¥è¿è¡Œ mock-agent.sh
        // æ³¨æ„ï¼šæˆ‘ä»¬ç›´æ¥åœ¨å‘½ä»¤é‡Œç”¨ bash è¿è¡ŒæŒ‚è½½è¿›å»çš„è„šæœ¬
        List<String> cmd = List.of(
            "docker", "run", "--rm", "-i", // <--- æ³¨æ„å¿…é¡»åŠ  -i (Interactive) ä¿æŒæ ‡å‡†è¾“å…¥å¼€å¯
            "-v", sourceCodePath.toAbsolutePath() + ":/src",
            "ubuntu:latest",
            "bash", "/src/mock-agent.sh" // è¿è¡ŒæŒ‚è½½è¿›å»çš„è„šæœ¬
        );

        log.info("ğŸ­ Starting Mock Agent Test...");
        interactiveRunner.runInteractive(cmd, 60); // 60ç§’è¶…æ—¶
    }